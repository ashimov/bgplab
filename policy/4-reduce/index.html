<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ivan Pepelnjak, ipSpace.net AG">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Minimize the Size of Your BGP Table - BGP Configuration Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">BGP Configuration Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../.." class="dropdown-item">Labs Overview</a>
</li>
                                    
<li>
    <a href="../../1-setup/" class="dropdown-item">Installation and Setup</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Custom Lab Infrastructure</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../external/" class="dropdown-item">Manual Setup</a>
</li>
            
<li>
    <a href="../../external/4-router/" class="dropdown-item">Small (4-Router) Lab Topology</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../basic/1-session/" class="dropdown-item">Configure a Single EBGP Session</a>
</li>
                                    
<li>
    <a href="../../basic/2-multihomed/" class="dropdown-item">Configure Multiple EBGP Sessions</a>
</li>
                                    
<li>
    <a href="../../basic/3-originate/" class="dropdown-item">Advertise IPv4 Prefixes to BGP Neighbors</a>
</li>
                                    
<li>
    <a href="../../basic/4-ipv6/" class="dropdown-item">Configure BGP for IPv6</a>
</li>
                                    
<li>
    <a href="../../basic/5-redistribute/" class="dropdown-item">Redistribute IGP Information Into BGP</a>
</li>
                                    
<li>
    <a href="../../basic/6-protect/" class="dropdown-item">Protect EBGP Sessions</a>
</li>
                                    
<li>
    <a href="../../basic/7-bfd/" class="dropdown-item">Use BFD to Speed Up BGP Convergence</a>
</li>
                                    
<li>
    <a href="../../basic/8-aggregate/" class="dropdown-item">BGP Route Aggregation</a>
</li>
                                    
<li>
    <a href="../../basic/9-ao/" class="dropdown-item">Protect BGP Sessions with TCP Authentication Option (TCP-AO)</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Simple Policies <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../1-weights/" class="dropdown-item">Select Preferred EBGP Peer with Weights</a>
</li>
                                    
<li>
    <a href="../2-stop-transit/" class="dropdown-item">Filter Transit Routes</a>
</li>
                                    
<li>
    <a href="../3-prefix/" class="dropdown-item">Filter Advertised Prefixes</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Minimize the Size of Your BGP Table</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../3-prefix/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/ipspace/bgplab/edit/master/docs/policy/4-reduce.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#minimize-the-size-of-your-bgp-table" class="nav-link">Minimize the Size of Your BGP Table</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#existing-bgp-configuration" class="nav-link">Existing BGP Configuration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#start-the-lab" class="nav-link">Start the Lab</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#configuration-tasks" class="nav-link">Configuration Tasks</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#verification" class="nav-link">Verification</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#reference-information" class="nav-link">Reference Information</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="minimize-the-size-of-your-bgp-table">Minimize the Size of Your BGP Table</h1>
<p>In the previous lab exercises you establish EBGP sessions with two upstream Service Providers, accepted all routes they were willing to send you, and let your router do its magic selecting the best BGP routes (either based on AS-path length or <a href="../1-weights/">weights</a>).</p>
<p>That might not be a good idea if you bought cost-optimized hardware that can do packet forwarding at ludicrous speeds but only for a few tens of thousands of routes while your neighbors send you the full Internet BGP table (over 930.000 routes in August 2023).</p>
<p>In this lab exercise you&rsquo;ll use inbound filters to reduce the amount of information inserted in the BGP table (and subsequently routing table) of your device.</p>
<p><img alt="Lab topology" src="../topology-stop-transit.png" /></p>
<p>Your link to ISP-1 is much faster than the link to ISP-2, so you have to use ISP-1 for most of the outbound traffic. As X1 advertises a default route to you, you don&rsquo;t have to accept any other routing information from it.</p>
<p>It would be a shame to let the link to ISP-2 remain idle while the link to ISP-1 is operational. Let&rsquo;s send the traffic for AS 65101 directly over the link to X2 &ndash; that means you have to accept prefixes originated in AS 65101 from X2.</p>
<p>Finally, you&rsquo;ll need a default route even if the link to ISP-1 goes down. You should therefore accept the default route from ISP-2 as well, but make it less preferred than the one received from ISP-1.</p>
<h2 id="existing-bgp-configuration">Existing BGP Configuration</h2>
<p>The routers in your lab use the following BGP AS numbers. Each autonomous system advertises one loopback address and another IPv4 prefix. Upstream routers (x1, x2) also advertise the default route to your router (rtr).</p>
<table>
<thead>
<tr>
<th>Node/ASN</th>
<th style="text-align: right;">Router ID</th>
<th style="text-align: right;">Advertised prefixes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AS65000</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>rtr</td>
<td style="text-align: right;">10.0.0.1</td>
<td style="text-align: right;">10.0.0.1/32<br>192.168.42.0/24</td>
</tr>
<tr>
<td><strong>AS65100</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>x1</td>
<td style="text-align: right;">10.0.0.10</td>
<td style="text-align: right;">10.0.0.10/32<br>192.168.100.0/24</td>
</tr>
<tr>
<td><strong>AS65101</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>x2</td>
<td style="text-align: right;">10.0.0.11</td>
<td style="text-align: right;">10.0.0.11/32<br>192.168.101.0/24</td>
</tr>
</tbody>
</table>
<p>Your router has these EBGP neighbors. <em>netlab</em> configures them automatically; if you&rsquo;re using some other lab infrastructure, you&rsquo;ll have to configure EBGP neighbors and advertised prefixes manually.</p>
<table>
<thead>
<tr>
<th>Neighbor</th>
<th style="text-align: right;">Neighbor IPv4</th>
<th style="text-align: right;">Neighbor AS</th>
</tr>
</thead>
<tbody>
<tr>
<td>x1</td>
<td style="text-align: right;">10.1.0.2</td>
<td style="text-align: right;">65100</td>
</tr>
<tr>
<td>x2</td>
<td style="text-align: right;">10.1.0.6</td>
<td style="text-align: right;">65101</td>
</tr>
</tbody>
</table>
<h2 id="start-the-lab">Start the Lab</h2>
<p>Assuming you already <a href="../../1-setup/">set up your lab infrastructure</a>:</p>
<ul>
<li>Change directory to <code>policy/4-reduce</code></li>
<li>Execute <strong>netlab up</strong> (<a href="../../external/">other options</a>)</li>
<li>Log into your device (RTR) with <strong>netlab connect rtr</strong> and verify IP addresses and BGP configuration.</li>
</ul>
<p><strong>Note:</strong> <em>netlab</em> will configure IP addressing, EBGP sessions, and BGP prefix advertisements on your router. If you&rsquo;re not using <em>netlab</em> just continue with the configuration you made during the <a href="../3-prefix/">previous exercise</a>.</p>
<h2 id="configuration-tasks">Configuration Tasks</h2>
<ul>
<li>Configure a <em>prefix list</em> that will accept just the default route and apply it as an inbound filter on the EBGP session with X1. You did something very similar in the <em><a href="../3-prefix/">Filter Advertised Prefixes</a></em> exercise, so you should be familiar with the process.</li>
<li>The inbound filter for X2 is a bit more complex: you have to accept a prefix if it originates in AS 65101 or if it&rsquo;s the default route. You already implemented <a href="../3-prefix/">prefix filters</a> and <a href="../2-stop-transit/">AS-path based filters</a>, now you have to combine them. Implementing such a condition usually requires a more complex routing policy; many BGP implementations call it a <em>route map</em>. </li>
</ul>
<p><strong>Hint</strong>: You&rsquo;ll have to get fluent with regular expressions if you want to become a master of BGP routing policies, but let&rsquo;s do things one step at a time &ndash; the regular expression <code>65101$</code> matches prefixes originating in AS 65101.</p>
<ul>
<li>Finally, you have to make routes received from X1 preferred over routes received from X2. You did exactly that in the <em><a href="../1-weights/">Select Preferred EBGP Peer with Weights</a></em> exercise, so you&rsquo;re good to go.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Applying routing policy parameters to BGP neighbors doesn&rsquo;t necessarily change the BGP table as the new parameters might be evaluated only on new incoming updates &ndash; you might have to use a command similar to <code>clear ip bgp * soft in</code> to tell your router to ask its neighbors to resend their BGP updates.</p>
</div>
<h2 id="verification">Verification</h2>
<p>Examine the BGP table on your device. It should contain:</p>
<ul>
<li>IP prefixes your device is originating;</li>
<li>Two IP prefixes originated by X2</li>
<li>Two paths for the default route; the path advertised by X1 should be the best path.</li>
</ul>
<p>If you&rsquo;re using Arista EOS, you should get this printout:</p>
<pre><code>rtr#sh ip bgp
BGP routing table information for VRF default
Router identifier 10.0.0.1, local AS number 65000
Route status codes: s - suppressed contributor, * - valid, &gt; - active, E - ECMP head, e - ECMP
                    S - Stale, c - Contributing to ECMP, b - backup, L - labeled-unicast
                    % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI Origin Validation codes: V - valid, I - invalid, U - unknown
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  AIGP       LocPref Weight  Path
 * &gt;      0.0.0.0/0              10.1.0.2              0       -          100     200     65100 i
 *        0.0.0.0/0              10.1.0.6              0       -          100     100     65101 i
 * &gt;      10.0.0.1/32            -                     -       -          -       0       i
 * &gt;      10.0.0.11/32           10.1.0.6              0       -          100     100     65101 i
 * &gt;      192.168.42.0/24        -                     -       -          -       0       ?
 * &gt;      192.168.101.0/24       10.1.0.6              0       -          100     100     65101 i
</code></pre>
<h2 id="reference-information">Reference Information</h2>
<p>You might find the following information useful if you&rsquo;re not using <em>netlab</em> to build the lab:</p>
<h3 id="lab-wiring">Lab Wiring</h3>
<p>This lab uses a subset of the <a href="../../external/4-router/">4-router lab topology</a>:</p>
<table>
<thead>
<tr>
<th>Origin Device</th>
<th>Origin Port</th>
<th>Destination Device</th>
<th>Destination Port</th>
</tr>
</thead>
<tbody>
<tr>
<td>rtr</td>
<td>Ethernet1</td>
<td>x1</td>
<td>swp1</td>
</tr>
<tr>
<td>rtr</td>
<td>Ethernet2</td>
<td>x2</td>
<td>swp1</td>
</tr>
<tr>
<td>x1</td>
<td>swp2</td>
<td>x2</td>
<td>swp2</td>
</tr>
</tbody>
</table>
<h3 id="lab-addressing">Lab Addressing</h3>
<table>
<thead>
<tr>
<th>Node/Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th style="text-align: right;">IPv6 Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>rtr</strong></td>
<td style="text-align: right;">10.0.0.1/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td style="text-align: right;"></td>
<td>rtr -&gt; x1</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;">10.1.0.5/30</td>
<td style="text-align: right;"></td>
<td>rtr -&gt; x2</td>
</tr>
<tr>
<td><strong>x1</strong></td>
<td style="text-align: right;">10.0.0.10/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td style="text-align: right;"></td>
<td>x1 -&gt; rtr</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.9/30</td>
<td style="text-align: right;"></td>
<td>x1 -&gt; x2</td>
</tr>
<tr>
<td><strong>x2</strong></td>
<td style="text-align: right;">10.0.0.11/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>swp1</td>
<td style="text-align: right;">10.1.0.6/30</td>
<td style="text-align: right;"></td>
<td>x2 -&gt; rtr</td>
</tr>
<tr>
<td>swp2</td>
<td style="text-align: right;">10.1.0.10/30</td>
<td style="text-align: right;"></td>
<td>x2 -&gt; x1</td>
</tr>
</tbody>
</table></div>
            </div>
        </div>

        <footer class="col-md-12">
<hr>
    <p>(C) 2023 Ivan Pepelnjak (ipSpace.net AG)</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
